{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Campaign Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="text-light">{{ campaign.name }}</h1>
            <p class="text-muted">Campaign Details</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('campaigns.campaigns_list') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Campaigns
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Campaign Information -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Campaign Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if campaign.status == 'SENT' %}
                                        <span class="badge bg-success">{{ campaign.status }}</span>
                                    {% elif campaign.status == 'DRAFT' %}
                                        <span class="badge bg-secondary">{{ campaign.status }}</span>
                                    {% elif campaign.status == 'SENDING' %}
                                        <span class="badge bg-primary">{{ campaign.status }}</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ campaign.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Subject:</th>
                                <td>{{ campaign.subject or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>From Name:</th>
                                <td>{{ campaign.from.name if campaign.from else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>From Email:</th>
                                <td>{{ campaign.from.email_address if campaign.from else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td>{{ campaign.created_at or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Sent:</th>
                                <td>{{ campaign.sent_at or 'Not sent yet' }}</td>
                            </tr>
                            <tr>
                                <th>Campaign ID:</th>
                                <td><code>{{ campaign.id }}</code></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Campaign Statistics -->
        {% if reports %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Campaign Statistics</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            {# Extract counts - handle both simple numbers and nested objects #}
                            {% set sent_count = reports.sent if reports.sent is number else 0 %}
                            {% set bounced_count = reports.bounced if reports.bounced is number else 0 %}
                            {% set complained_count = reports.complained if reports.complained is number else 0 %}
                            {% set unsubscribed_count = reports.unsubscribed if reports.unsubscribed is number else 0 %}

                            {# opened and clicked are objects with 'unique' and 'total' properties #}
                            {% if reports.opened is mapping %}
                                {% set opened_unique = reports.opened.unique if reports.opened.unique is number else 0 %}
                                {% set opened_total = reports.opened.total if reports.opened.total is number else 0 %}
                            {% else %}
                                {% set opened_unique = reports.opened if reports.opened is number else 0 %}
                                {% set opened_total = reports.opened if reports.opened is number else 0 %}
                            {% endif %}

                            {% if reports.clicked is mapping %}
                                {% set clicked_unique = reports.clicked.unique if reports.clicked.unique is number else 0 %}
                                {% set clicked_total = reports.clicked.total if reports.clicked.total is number else 0 %}
                            {% else %}
                                {% set clicked_unique = reports.clicked if reports.clicked is number else 0 %}
                                {% set clicked_total = reports.clicked if reports.clicked is number else 0 %}
                            {% endif %}

                            <tr>
                                <th>Sent:</th>
                                <td>{{ sent_count }}</td>
                            </tr>
                            <tr>
                                <th>Bounced:</th>
                                <td>{{ bounced_count }}</td>
                            </tr>
                            <tr>
                                <th>Opened:</th>
                                <td>
                                    {{ opened_unique }} unique
                                    {% if opened_total > opened_unique %}
                                        <span class="text-muted">({{ opened_total }} total)</span>
                                    {% endif %}
                                    {% if sent_count > 0 %}
                                        <span class="text-muted">
                                            - {{ "%.1f"|format((opened_unique / sent_count * 100)) }}%
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Clicked:</th>
                                <td>
                                    {{ clicked_unique }} unique
                                    {% if clicked_total > clicked_unique %}
                                        <span class="text-muted">({{ clicked_total }} total)</span>
                                    {% endif %}
                                    {% if sent_count > 0 %}
                                        <span class="text-muted">
                                            - {{ "%.1f"|format((clicked_unique / sent_count * 100)) }}%
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Complained:</th>
                                <td>{{ complained_count }}</td>
                            </tr>
                            <tr>
                                <th>Unsubscribed:</th>
                                <td>{{ unsubscribed_count }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Visual representation of stats -->
                    <div class="mt-3">
                        <h6>Open Rate (Unique)</h6>
                        <div class="progress mb-3">
                            {% set open_rate = (opened_unique / sent_count * 100) if sent_count > 0 else 0 %}
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ open_rate }}%"
                                 aria-valuenow="{{ open_rate }}" aria-valuemin="0" aria-valuemax="100">
                                {{ "%.1f"|format(open_rate) }}%
                            </div>
                        </div>

                        <h6>Click Rate (Unique)</h6>
                        <div class="progress">
                            {% set click_rate = (clicked_unique / sent_count * 100) if sent_count > 0 else 0 %}
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: {{ click_rate }}%"
                                 aria-valuenow="{{ click_rate }}" aria-valuemin="0" aria-valuemax="100">
                                {{ "%.1f"|format(click_rate) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Campaign Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        Statistics are not yet available for this campaign.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Campaign Content Preview -->
    {% if campaign.content %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Content Preview</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                        {% if campaign.content.html %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="html-tab" data-bs-toggle="tab"
                                    data-bs-target="#html-content" type="button" role="tab">
                                HTML
                            </button>
                        </li>
                        {% endif %}
                        {% if campaign.content.plain_text %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if not campaign.content.html %}active{% endif %}"
                                    id="text-tab" data-bs-toggle="tab"
                                    data-bs-target="#text-content" type="button" role="tab">
                                Plain Text
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                    <div class="tab-content p-3 border border-top-0" id="contentTabsContent">
                        {% if campaign.content.html %}
                        <div class="tab-pane fade show active" id="html-content" role="tabpanel">
                            <div class="alert alert-warning">
                                <strong>Note:</strong> HTML content preview. Full rendering may differ.
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; background: #f8f9fa;">
                                {{ campaign.content.html|safe }}
                            </div>
                        </div>
                        {% endif %}
                        {% if campaign.content.plain_text %}
                        <div class="tab-pane fade {% if not campaign.content.html %}show active{% endif %}"
                             id="text-content" role="tabpanel">
                            <pre style="max-height: 400px; overflow-y: auto;">{{ campaign.content.plain_text }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Data Tables with Tabs -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="dataTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="participants-tab" data-bs-toggle="tab"
                                    data-bs-target="#participants-content" type="button" role="tab">
                                <i class="bi bi-people"></i> Campaign Participants
                                <span class="badge bg-info ms-2">{{ participants|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="enriched-tab" data-bs-toggle="tab"
                                    data-bs-target="#enriched-content" type="button" role="tab"
                                    onclick="loadEnrichedData()">
                                <i class="bi bi-table"></i> Enriched Campaign Data
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="histogram-tab" data-bs-toggle="tab"
                                    data-bs-target="#histogram-content" type="button" role="tab"
                                    onclick="loadHistogramData()">
                                <i class="bi bi-bar-chart"></i> Savings Distribution
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="tab-content">
                    <!-- Participants Tab -->
                    <div class="tab-pane fade show active" id="participants-content" role="tabpanel">
                        <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="mb-3">
                        <div class="btn-group" role="group" aria-label="Filter participants">
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='all') }}"
                               class="btn btn-sm {{ 'btn-primary' if filter_type == 'all' else 'btn-outline-primary' }}">
                                <i class="bi bi-people"></i> All Subscribed
                            </a>
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='opened') }}"
                               class="btn btn-sm {{ 'btn-success' if filter_type == 'opened' else 'btn-outline-success' }}">
                                <i class="bi bi-envelope-open"></i> Opened
                            </a>
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='clicked') }}"
                               class="btn btn-sm {{ 'btn-info' if filter_type == 'clicked' else 'btn-outline-info' }}">
                                <i class="bi bi-hand-index"></i> Clicked
                            </a>
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='bounced') }}"
                               class="btn btn-sm {{ 'btn-warning' if filter_type == 'bounced' else 'btn-outline-warning' }}">
                                <i class="bi bi-exclamation-triangle"></i> Bounced
                            </a>
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='complained') }}"
                               class="btn btn-sm {{ 'btn-danger' if filter_type == 'complained' else 'btn-outline-danger' }}">
                                <i class="bi bi-flag"></i> Complained
                            </a>
                            <a href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, filter='unsubscribed') }}"
                               class="btn btn-sm {{ 'btn-secondary' if filter_type == 'unsubscribed' else 'btn-outline-secondary' }}">
                                <i class="bi bi-x-circle"></i> Unsubscribed
                            </a>
                        </div>
                        <small class="text-muted d-block mt-2">
                            {% if filter_type == 'all' %}
                            Showing all subscribed contacts from campaign list
                            {% elif filter_type == 'opened' %}
                            Showing contacts who opened this email
                            {% elif filter_type == 'clicked' %}
                            Showing contacts who clicked a link in this email
                            {% elif filter_type == 'bounced' %}
                            Showing contacts whose emails bounced
                            {% elif filter_type == 'complained' %}
                            Showing contacts who marked this as spam
                            {% elif filter_type == 'unsubscribed' %}
                            Showing contacts who unsubscribed from this campaign
                            {% endif %}
                        </small>
                    </div>

                    {% if participants %}
                    <!-- Toggle Energy Costs Button -->
                    <div class="mb-2">
                        <button class="btn btn-sm btn-outline-secondary" id="toggle-energy-costs" onclick="toggleEnergyCosts()">
                            <i class="bi bi-currency-dollar"></i> Show Energy Costs
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="participants-table">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>City</th>
                                    <th>ZIP</th>
                                    <th>kWh</th>
                                    <th>Cell</th>
                                    <th>Address</th>
                                    <th class="energy-cost-column" style="display: none;">Annual Cost</th>
                                    <th class="energy-cost-column" style="display: none;">Annual Savings</th>
                                    <th class="energy-cost-column" style="display: none;">Monthly Cost</th>
                                    <th class="energy-cost-column" style="display: none;">Monthly Saving</th>
                                    <th class="energy-cost-column" style="display: none;">Daily Cost</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for participant in participants %}
                                <tr>
                                    <td>{{ participant.email_address }}</td>
                                    <td>{{ participant.fields.FirstName|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.LastName|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.City|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.ZIP|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.kWh|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.Cell|default('N/A', true) }}</td>
                                    <td>{{ participant.fields.Address|default('N/A', true) }}</td>
                                    <td class="energy-cost-column" style="display: none;">{{ participant.fields.annualcost|default('N/A', true) }}</td>
                                    <td class="energy-cost-column" style="display: none;">{{ participant.fields.AnnualSavings|default('N/A', true) }}</td>
                                    <td class="energy-cost-column" style="display: none;">{{ participant.fields.MonthlyCost|default('N/A', true) }}</td>
                                    <td class="energy-cost-column" style="display: none;">{{ participant.fields.MonthlySaving|default('N/A', true) }}</td>
                                    <td class="energy-cost-column" style="display: none;">{{ participant.fields.DailyCost|default('N/A', true) }}</td>
                                    <td>
                                        {% if participant.status == 'SUBSCRIBED' %}
                                            <span class="badge bg-success">{{ participant.status }}</span>
                                        {% elif participant.status == 'UNSUBSCRIBED' %}
                                            <span class="badge bg-secondary">{{ participant.status }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ participant.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <script>
                    function toggleEnergyCosts() {
                        const columns = document.querySelectorAll('.energy-cost-column');
                        const button = document.getElementById('toggle-energy-costs');
                        const isHidden = columns[0].style.display === 'none';

                        columns.forEach(col => {
                            col.style.display = isHidden ? '' : 'none';
                        });

                        if (isHidden) {
                            button.innerHTML = '<i class="bi bi-currency-dollar"></i> Hide Energy Costs';
                            button.classList.remove('btn-outline-secondary');
                            button.classList.add('btn-secondary');
                        } else {
                            button.innerHTML = '<i class="bi bi-currency-dollar"></i> Show Energy Costs';
                            button.classList.remove('btn-secondary');
                            button.classList.add('btn-outline-secondary');
                        }
                    }
                    </script>

                    <!-- Pagination Controls -->
                    {% if participants_paging %}
                    <nav aria-label="Participant pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if participants_paging.previous %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, page=current_page-1, filter=filter_type) }}">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i> Previous</span>
                            </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">Page {{ current_page }}</span>
                            </li>

                            {% if participants_paging.next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('campaigns.campaign_detail', campaign_id=campaign.id, page=current_page+1, filter=filter_type) }}">
                                    Next <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next <i class="bi bi-chevron-right"></i></span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-info">
                        No participants found for this filter.
                    </div>
                    {% endif %}
                        </div>
                    </div>

                    <!-- Enriched Data Tab -->
                    <div class="tab-pane fade" id="enriched-content" role="tabpanel">
                        <div class="card-body">
                            <!-- Loading State -->
                            <div id="enriched-loading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Loading enriched campaign data...</p>
                            </div>

                            <!-- Error State -->
                            <div id="enriched-error" class="alert alert-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span id="enriched-error-message"></span>
                            </div>

                            <!-- Controls -->
                            <div id="enriched-controls" style="display: none;" class="mb-3">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div>
                                        <button class="btn btn-primary btn-sm" id="btn-toggle-columns">
                                            <i class="bi bi-eye"></i> Show/Hide Columns
                                        </button>
                                        <a href="{{ url_for('campaigns.download_enriched', campaign_id=campaign.id) }}"
                                           class="btn btn-success btn-sm ms-2">
                                            <i class="bi bi-download"></i> Download CSV
                                        </a>
                                    </div>
                                    <span class="badge bg-info fs-6" id="enriched-row-count">0 rows</span>
                                </div>

                                <!-- Column Selector Panel -->
                                <div id="column-selector" class="card mt-3" style="display: none;">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Select Columns to Display</h6>
                                        <div class="row g-2" id="column-checkboxes">
                                            <!-- Populated dynamically -->
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllColumns()">
                                                <i class="bi bi-check-all"></i> Select All
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllColumns()">
                                                <i class="bi bi-x"></i> Deselect All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Table -->
                            <div id="enriched-table-container" style="display: none;">
                                <div class="table-responsive">
                                    <table id="enriched-table" class="table table-striped table-bordered table-hover" style="width:100%">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Histogram Tab -->
                    <div class="tab-pane fade" id="histogram-content" role="tabpanel">
                        <div class="card-body">
                            <!-- Loading State -->
                            <div id="histogram-loading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Generating savings distribution chart...</p>
                            </div>

                            <!-- Error State -->
                            <div id="histogram-error" class="alert alert-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span id="histogram-error-message"></span>
                            </div>

                            <!-- Chart Container -->
                            <div id="histogram-chart-container" style="display: none;">
                                <div class="mb-3">
                                    <h5>Annual Savings Distribution</h5>
                                    <p class="text-muted">
                                        Shows the distribution of all campaign participants across savings ranges with engagement rates.
                                        <br>
                                        <span class="badge bg-primary">Blue Bars (Left Axis)</span> = Total Participants |
                                        <span class="badge bg-success">Green Bars (Middle Right Axis)</span> = Opened Email |
                                        <span class="badge bg-danger">Red Line (Far Right Axis)</span> = Open Rate %
                                    </p>
                                </div>
                                <div class="chart-wrapper" style="position: relative; height: 400px;">
                                    <canvas id="savingsHistogram"></canvas>
                                </div>
                                <div class="mt-3">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title text-muted">Total Participants</h6>
                                                    <h3 id="total-participants-count">-</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title text-muted">Savings Range</h6>
                                                    <h3 id="savings-range">-</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title text-muted">Open Rate</h6>
                                                    <h3 id="overall-open-rate">-</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<!-- DataTables JavaScript -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let enrichedTable = null;
let enrichedData = null;
let enrichedColumns = null;
let visibleColumns = [];

function loadEnrichedData() {
    // Load only once
    if (enrichedData !== null) return;

    const campaignId = '{{ campaign.id }}';

    $('#enriched-loading').show();
    $('#enriched-error').hide();
    $('#enriched-controls').hide();
    $('#enriched-table-container').hide();

    fetch(`/api/campaigns/${campaignId}/enriched-data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                enrichedData = data.data;
                enrichedColumns = data.columns;
                visibleColumns = [...enrichedColumns]; // All visible by default

                $('#enriched-loading').hide();
                $('#enriched-controls').show();
                $('#enriched-table-container').show();
                $('#enriched-row-count').text(`${data.row_count} rows`);

                initializeTable();
                populateColumnCheckboxes();
            } else {
                showError(data.message || 'No enriched data available for this campaign');
            }
        })
        .catch(error => {
            console.error('Error loading enriched data:', error);
            showError('Error loading enriched data. Please try again.');
        });
}

function initializeTable() {
    if (enrichedTable) {
        enrichedTable.destroy();
    }

    // Build column definitions
    const columns = enrichedColumns.map(col => ({
        data: col,
        title: formatColumnName(col),
        visible: visibleColumns.includes(col)
    }));

    // Initialize DataTable
    enrichedTable = $('#enriched-table').DataTable({
        data: enrichedData,
        columns: columns,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        responsive: true,
        scrollX: true,
        order: [[0, 'asc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search data...",
            lengthMenu: "Show _MENU_ rows",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "No entries to show",
            infoFiltered: "(filtered from _MAX_ total entries)"
        }
    });
}

function formatColumnName(name) {
    // Convert snake_case to Title Case
    return name
        .replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

function populateColumnCheckboxes() {
    const container = $('#column-checkboxes');
    container.empty();

    enrichedColumns.forEach((col, idx) => {
        const isVisible = visibleColumns.includes(col);
        const checkbox = $(`
            <div class="col-md-3 col-sm-4 col-6">
                <div class="form-check">
                    <input class="form-check-input column-checkbox" type="checkbox"
                           id="col-${idx}" data-column="${col}" ${isVisible ? 'checked' : ''}>
                    <label class="form-check-label" for="col-${idx}">
                        ${formatColumnName(col)}
                    </label>
                </div>
            </div>
        `);
        container.append(checkbox);
    });

    // Handle checkbox changes
    $('.column-checkbox').on('change', function() {
        const column = $(this).data('column');
        const isChecked = $(this).is(':checked');

        if (isChecked && !visibleColumns.includes(column)) {
            visibleColumns.push(column);
        } else if (!isChecked) {
            visibleColumns = visibleColumns.filter(c => c !== column);
        }

        updateColumnVisibility();
    });
}

function updateColumnVisibility() {
    enrichedColumns.forEach((col, idx) => {
        const column = enrichedTable.column(idx);
        column.visible(visibleColumns.includes(col));
    });
}

function selectAllColumns() {
    visibleColumns = [...enrichedColumns];
    $('.column-checkbox').prop('checked', true);
    updateColumnVisibility();
}

function deselectAllColumns() {
    visibleColumns = [];
    $('.column-checkbox').prop('checked', false);
    updateColumnVisibility();
}

function showError(message) {
    $('#enriched-loading').hide();
    $('#enriched-error-message').text(message);
    $('#enriched-error').show();
}

// Toggle column selector
$('#btn-toggle-columns').on('click', function() {
    $('#column-selector').slideToggle();
});

// ========================================
// Savings Histogram Chart
// ========================================

let histogramChart = null;
let histogramData = null;

function loadHistogramData() {
    // Load only once
    if (histogramData !== null) return;

    const campaignId = '{{ campaign.id }}';

    $('#histogram-loading').show();
    $('#histogram-error').hide();
    $('#histogram-chart-container').hide();

    fetch(`/api/campaigns/${campaignId}/savings-histogram`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                histogramData = data;
                $('#histogram-loading').hide();
                $('#histogram-chart-container').show();
                renderHistogram(data);
                updateHistogramStats(data);
            } else {
                showHistogramError(data.message || 'No savings data available for this campaign');
            }
        })
        .catch(error => {
            console.error('Error loading histogram data:', error);
            showHistogramError('Error loading histogram data. Please try again.');
        });
}

function renderHistogram(data) {
    const ctx = document.getElementById('savingsHistogram').getContext('2d');

    // Destroy existing chart if present
    if (histogramChart) {
        histogramChart.destroy();
    }

    // Prepare data
    const labels = data.bins.map(bin => bin.range_label);
    const totalCounts = data.bins.map(bin => bin.total_count);
    const openedCounts = data.bins.map(bin => bin.opened_count);

    // Calculate percentage for each bin
    const percentages = data.bins.map(bin => {
        if (bin.total_count === 0) return 0;
        return ((bin.opened_count / bin.total_count) * 100);
    });

    // Create chart with dual y-axes and line overlay
    histogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total Participants',
                    data: totalCounts,
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-total',
                    order: 2
                },
                {
                    label: 'Opened Email',
                    data: openedCounts,
                    backgroundColor: 'rgba(25, 135, 84, 0.6)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-opened',
                    order: 2
                },
                {
                    label: 'Open Rate %',
                    data: percentages,
                    type: 'line',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(220, 53, 69, 1)',
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y-percentage',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }

                            // Format based on dataset type
                            if (context.datasetIndex === 2) {
                                // Percentage line
                                label += context.parsed.y.toFixed(1) + '%';
                            } else {
                                // Bar charts
                                label += context.parsed.y + ' participants';

                                // Add percentage for opened
                                if (context.datasetIndex === 1 && totalCounts[context.dataIndex] > 0) {
                                    const percentage = (context.parsed.y / totalCounts[context.dataIndex] * 100).toFixed(1);
                                    label += ` (${percentage}%)`;
                                }
                            }

                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Annual Savings Range',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                'y-total': {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Total Participants',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: 'rgba(13, 110, 253, 1)'
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        },
                        color: 'rgba(13, 110, 253, 1)'
                    },
                    grid: {
                        drawOnChartArea: true
                    }
                },
                'y-opened': {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Opened Email',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: 'rgba(25, 135, 84, 1)'
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        },
                        color: 'rgba(25, 135, 84, 1)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                'y-percentage': {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Open Rate %',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: 'rgba(220, 53, 69, 1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        },
                        color: 'rgba(220, 53, 69, 1)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function updateHistogramStats(data) {
    // Total participants
    $('#total-participants-count').text(data.total_participants);

    // Savings range
    const range = `$${data.min_savings.toLocaleString()} - $${data.max_savings.toLocaleString()}`;
    $('#savings-range').text(range);

    // Calculate overall open rate
    const totalOpened = data.bins.reduce((sum, bin) => sum + bin.opened_count, 0);
    const openRate = ((totalOpened / data.total_participants) * 100).toFixed(1);
    $('#overall-open-rate').text(`${openRate}%`);
}

function showHistogramError(message) {
    $('#histogram-loading').hide();
    $('#histogram-error-message').text(message);
    $('#histogram-error').show();
}
</script>

{% endblock %}
